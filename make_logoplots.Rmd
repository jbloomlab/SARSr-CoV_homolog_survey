---
title: "Make logoplot visualizations for SSM homolog x ACE2 data"
author: "Tyler Starr"
date: "10/27/2020"
output:
  github_document:
    toc: true
    html_preview: false
editor_options: 
  chunk_output_type: inline
---


```{r setup, message=FALSE, warning=FALSE, error=FALSE}
require("knitr")
knitr::opts_chunk$set(echo = T)
knitr::opts_chunk$set(dev.args = list(png = list(type = "cairo")))

#list of packages to install/load
packages = c("yaml","data.table","tidyverse","gridExtra","egg","ggseqlogo")
#install any packages not already installed
installed_packages <- packages %in% rownames(installed.packages())
if(any(installed_packages == F)){
  install.packages(packages[!installed_packages])
}
#load packages
invisible(lapply(packages, library, character.only=T))

#read in config file
config <- read_yaml("config.yaml")

#make output directory
if(!file.exists(config$logoplots_dir)){
  dir.create(file.path(config$logoplots_dir))
}
```
Session info for reproducing environment:
```{r print_sessionInfo}
sessionInfo()
```

## Setup

Read in tables of per-mutant and per-homolog phenotypes. Set some factors for ordering backgrounds and sites.

```{r input_data}
dt_mutant <- data.table(read.csv(config$final_variant_scores_mut_file),stringsAsFactors=F)
#order target by order given in config
dt_mutant$target <- factor(dt_mutant$target,levels=config$mutated_targets_ordered)
#order mutant as a factor for grouping by rough biochemical grouping
dt_mutant$mutant <- factor(dt_mutant$mutant, levels=c("C","P","G","V","M","L","I","A","F","W","Y","T","S","N","Q","E","D","H","K","R"))
#order sites as a factor variable
dt_mutant$position <- factor(dt_mutant$position,levels=c(455,486,493,494,498,501))

dt_wt <- data.table(read.csv(config$final_variant_scores_wt_file),stringsAsFactors=F)
#assign target as a factor in my desired overall plotting order
dt_wt[,target := factor(dt_wt$target,levels=config$targets_ordered)]
```

## Calculate "preferences" at each site for binding

Calculate preference by exponentiating an alpha-multiplied delta_log10Ka, and normalizing values at each site to sum to one. We'll start with alpha 1.4 as used in the deep mutational scanning paper.

```{r calculate_prefs}
alpha <- 3.5
dt_mutant[,pref_huACE2:=as.numeric(NA)]
for(i in 1:nrow(dt_mutant)){
  dt_mutant[i,"pref_huACE2"] <- exp(alpha*dt_mutant[i,huACE2])/sum(exp(alpha*dt_mutant[target==dt_mutant[i,target] & position==dt_mutant[i,position],huACE2]),na.rm=T)
}

for(i in 1:nrow(dt_mutant)){
  dt_mutant[i,"pref_RaACE2"] <- exp(alpha*dt_mutant[i,RaACE2])/sum(exp(alpha*dt_mutant[target==dt_mutant[i,target] & position==dt_mutant[i,position],RaACE2]),na.rm=T)
}

for(i in 1:nrow(dt_mutant)){
  dt_mutant[i,"pref_RsACE2"] <- exp(alpha*dt_mutant[i,RsACE2])/sum(exp(alpha*dt_mutant[target==dt_mutant[i,target] & position==dt_mutant[i,position],RsACE2]),na.rm=T)
}
#dt_mutant[,wf_huACE2:=exp(alpha*huACE2),by=c("target","position","mutant")]
#dt_mutant[,pref_huACE2:=wf_huACE2/sum(dt_mutant[dt_mutant$target==target & #dt_mutant$position==position,wf_huACE2],na.rm=T),by=c("target","position","mutant")]
#/sum(exp(alpha*dt_mutant[dt_mutant$target==target & dt_mutant$position==position,huACE2]),na.rm=T)
```

Use `ggseqlogo` to draw logoplots from preferences.

```{r draw_logos_huACE2, fig.width=13, fig.height=5, fig.align="center", dpi=300,dev="png"}
list <- vector("list",length(levels(dt_mutant$target)));names(list) <- levels(dt_mutant$target)
#make a named list of matrices for facet wrap drawing of custom logoplots
for(seq in levels(dt_mutant$target)){
  mat <- as.matrix(pivot_wider(dt_mutant[target==seq,c("position","mutant","pref_huACE2")], names_from=position, values_from=pref_huACE2)[,-1])
  row.names(mat) <- unique(dt_mutant$mutant)
  list[[seq]] <- mat
}

ggseqlogo(list, method="custom", seq_type="aa")
```

```{r draw_logos_RaACE2, fig.width=13, fig.height=5, fig.align="center", dpi=300,dev="png"}
list <- vector("list",length(levels(dt_mutant$target)));names(list) <- levels(dt_mutant$target)
#make a named list of matrices for facet wrap drawing of custom logoplots
for(seq in levels(dt_mutant$target)){
  mat <- as.matrix(pivot_wider(dt_mutant[target==seq,c("position","mutant","pref_RaACE2")], names_from=position, values_from=pref_RaACE2)[,-1])
  row.names(mat) <- unique(dt_mutant$mutant)
  list[[seq]] <- mat
}

ggseqlogo(list, method="custom", seq_type="aa")
```

```{r draw_logos_RsACE2, fig.width=13, fig.height=5, fig.align="center", dpi=300,dev="png"}
list <- vector("list",length(levels(dt_mutant$target)));names(list) <- levels(dt_mutant$target)
#make a named list of matrices for facet wrap drawing of custom logoplots
for(seq in levels(dt_mutant$target)){
  mat <- as.matrix(pivot_wider(dt_mutant[target==seq,c("position","mutant","pref_RsACE2")], names_from=position, values_from=pref_RsACE2)[,-1])
  row.names(mat) <- unique(dt_mutant$mutant)
  list[[seq]] <- mat
}

ggseqlogo(list, method="custom", seq_type="aa")
```

Facet logopots in a better way for comparison site by site -- I want it by site, with background arranged in one dimension, and protein ligands arranged in the other... (use the ncol=x argument) -- and then make this six times for each site? I don't know if this will be a reasonable figure/supplement display, but should enable better analytical data gazing

## Identify sites whose preferences differ most dramatically among ACE2 ligands (in paired tests for each background?)

## Identify backgrounds whose preferences for specific ACE2 ligands have diverged most dramatically.

## Or, identify positions whose preferences for ACE2 ligands (e.g. huACE2) differ most dramatically between the SARS1 and SARS2 lineages


